
<!doctype html>
<html lang="de" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Lehrmaterial, Übungen, Aufgaben und Hilfen für Aktuelle Trends der IKT">
      
      
      
        <meta name="author" content="Jörn Freiheit">
      
      
        <link rel="canonical" href="http://freiheit.f4.htw-berlin.de/ikt/devices/">
      
      <link rel="shortcut icon" href="../img/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.8">
    
    
      
        <title>Gerätezugriffe - Progressive Web Apps</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.cb6bc1d0.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.39b8e14a.min.css">
        
          
          
          <meta name="theme-color" content="#757575">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../extra.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="grey" data-md-color-accent="indigo">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#geratezugriffe" class="md-skip">
          Zum Inhalt
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="http://freiheit.f4.htw-berlin.de/ikt" title="Progressive Web Apps" class="md-header-nav__button md-logo" aria-label="Progressive Web Apps">
      
  <img src="../img/fiw.jpg" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            Progressive Web Apps
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              Gerätezugriffe
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Suche" placeholder="Suche" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Suche wird initialisiert
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/jfreiheit/ikt/" title="Quellcode" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    webtech
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="http://freiheit.f4.htw-berlin.de/ikt" title="Progressive Web Apps" class="md-nav__button md-logo" aria-label="Progressive Web Apps">
      
  <img src="../img/fiw.jpg" alt="logo">

    </a>
    Progressive Web Apps
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/jfreiheit/ikt/" title="Quellcode" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    webtech
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../einfuehrung/" class="md-nav__link">
        Einführung
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../grundgeruest/" class="md-nav__link">
        Grundgerüst
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../manifest/" class="md-nav__link">
        Manifest
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../serviceworker/" class="md-nav__link">
        Service Worker
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../promises/" class="md-nav__link">
        Promises & fetch
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../caching/" class="md-nav__link">
        Caching
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../backend/" class="md-nav__link">
        Backend
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../frontend/" class="md-nav__link">
        Frontend
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../indexeddb/" class="md-nav__link">
        IndexedDB
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../backgroundsync/" class="md-nav__link">
        Hintergrundsynchronisation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../pushnotes/" class="md-nav__link">
        Push Notifications
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Gerätezugriffe
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Gerätezugriffe
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Inhaltsverzeichnis">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Inhaltsverzeichnis
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#anpassung-der-anwendung" class="md-nav__link">
    Anpassung der Anwendung
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dom-zugriff" class="md-nav__link">
    DOM-Zugriff
  </a>
  
    <nav class="md-nav" aria-label="DOM-Zugriff">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kamera" class="md-nav__link">
    Kamera
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#speichern-des-bildes-im-backend" class="md-nav__link">
    Speichern des Bildes im Backend
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bilddatei-hochladen" class="md-nav__link">
    Bilddatei hochladen
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geolocation-api" class="md-nav__link">
    Geolocation-API
  </a>
  
    <nav class="md-nav" aria-label="Geolocation-API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#letzte-verbesserungen" class="md-nav__link">
    Letzte Verbesserungen
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../zusammenfassung/" class="md-nav__link">
        Zusammenfassung
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../uebungen/" class="md-nav__link">
        Übungen
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../tools/" class="md-nav__link">
        Werkzeuge
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../hilfen/" class="md-nav__link">
        Hilfen
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Inhaltsverzeichnis">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Inhaltsverzeichnis
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#anpassung-der-anwendung" class="md-nav__link">
    Anpassung der Anwendung
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dom-zugriff" class="md-nav__link">
    DOM-Zugriff
  </a>
  
    <nav class="md-nav" aria-label="DOM-Zugriff">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kamera" class="md-nav__link">
    Kamera
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#speichern-des-bildes-im-backend" class="md-nav__link">
    Speichern des Bildes im Backend
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bilddatei-hochladen" class="md-nav__link">
    Bilddatei hochladen
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geolocation-api" class="md-nav__link">
    Geolocation-API
  </a>
  
    <nav class="md-nav" aria-label="Geolocation-API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#letzte-verbesserungen" class="md-nav__link">
    Letzte Verbesserungen
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/jfreiheit/ikt/edit/master/docs/devices.md" title="Seite editieren" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="geratezugriffe">Gerätezugriffe<a class="headerlink" href="#geratezugriffe" title="Permanent link">&para;</a></h1>
<p>Nun wollen wir noch auf Geräteschnittstellen zugreifen. Dazu gehören die Kamera und auch die Geolocation-API, um unseren Standort zu ermitteln. Früher war JavaScript eine "SandBox", d.h. JavaScript-Code war vollständig innerhalb des Browsers gekapselt und hatte keinerlei Zugriff nach außen. Das änderte sich mit dem <code>Upload File</code>-Button. JavaScript bekam (sehr eingeschränkten) Zugriff auf das Dateisystem (nur lesend). In der Zwischenzeit hat sich das komplett gewandelt. JavaScript läuft erstens auch auf Servern und hat zweitens über eine Vielzahl von APIs Zugriff auf unterschiedlichste Schnittstellen zum System. Wir wollen hier betrachten, wie JavaScript auf Kamera und den Standort zugreifen kann. </p>
<h2 id="anpassung-der-anwendung">Anpassung der Anwendung<a class="headerlink" href="#anpassung-der-anwendung" title="Permanent link">&para;</a></h2>
<p>Ausgangspunkt ist <a href="../files/IKT-PWA-07.zip">dieser Stand des Projektes</a>, den wir nach dem Einfügen von <a href="../pushnotes/#push-notifications">Push-Notifications</a> erreicht haben. Wir wollen nun die Kamera verwenden, um Bilder aufzunehmen, dazu erweiteren wir die Anwendung zunächst, um neben <code>title</code> und <code>location</code> auch noch ein drittes EIngabefeld für die Bilder zu erhalten. </p>
<p>Dazu erweiteren wir zunächst die <code>public/index.html</code>: </p>
<div class="tabbed-set" data-tabs="1:1"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><label for="__tabbed_1_1">public/index.html</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;create-post&quot;</span><span class="p">&gt;</span>
<span class="hll">    <span class="p">&lt;</span><span class="nt">video</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;player&quot;</span> <span class="na">autoplay</span><span class="p">&gt;&lt;/</span><span class="nt">video</span><span class="p">&gt;</span>
</span><span class="hll">    <span class="p">&lt;</span><span class="nt">canvas</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;canvas&quot;</span> <span class="na">width</span><span class="o">=</span><span class="s">&quot;320px&quot;</span> <span class="na">height</span><span class="o">=</span><span class="s">&quot;240px&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">canvas</span><span class="p">&gt;</span>
</span><span class="hll">    <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;mdl-button mdl-js-button mdl-button--raised mdl-button--colored&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;capture-btn&quot;</span><span class="p">&gt;</span>Foto<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</span><span class="hll">    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;pick-image&quot;</span><span class="p">&gt;</span>
</span><span class="hll">        <span class="p">&lt;</span><span class="nt">h6</span><span class="p">&gt;</span>Bild auswählen<span class="p">&lt;/</span><span class="nt">h6</span><span class="p">&gt;</span>
</span><span class="hll">        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;file&quot;</span> <span class="na">accept</span><span class="o">=</span><span class="s">&quot;image/*&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;image-picker&quot;</span><span class="p">&gt;</span>
</span><span class="hll">    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span><span class="hll">    <span class="p">&lt;</span><span class="nt">form</span><span class="p">&gt;</span>
</span>        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;input-section mdl-textfield mdl-js-textfield mdl-textfield--floating-label&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">input</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;mdl-textfield__input&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;title&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">label</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;mdl-textfield__label&quot;</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;title&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;title&quot;</span><span class="p">&gt;</span>Titel<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;input-section mdl-textfield mdl-js-textfield mdl-textfield--floating-label&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;manual-location&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">input</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;mdl-textfield__input&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;location&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">label</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;mdl-textfield__label&quot;</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;location&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;location&quot;</span><span class="p">&gt;</span>Ort<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="hll">        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;input-section&quot;</span><span class="p">&gt;</span>
</span><span class="hll">            <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;mdl-button mdl-js-button mdl-button--colored&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;button&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;location-btn&quot;</span><span class="p">&gt;</span>Location<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</span><span class="hll">            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;mdl-spinner mdl-js-spinner is-active&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;location-loader&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span><span class="hll">        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span>        <span class="p">&lt;</span><span class="nt">br</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-color--accent&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;post-btn&quot;</span><span class="p">&gt;</span>Speichern
            <span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">br</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;mdl-button mdl-js-button mdl-button--fab&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;close-create-post-modal-btn&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;button&quot;</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">i</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;material-icons&quot;</span><span class="p">&gt;</span>close<span class="p">&lt;/</span><span class="nt">i</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>Das <code>&lt;video&gt;</code>- (Zeile <code>2</code>) und das <code>&lt;cabvas&gt;</code>-Element (Zeile <code>3</code>) werden verwendet, um mit der Kamera Bilder aufzunehmen, die mit dem <code>&lt;button&gt;</code> (Zeile <code>3</code>) gespeichert werden. Der <code>file-picker</code> (Zeilen <code>7-9</code>) wird benötigt, falls das Gerät über keine Kamera (oder keinen Kamerazugriff) verfügt. Außerdem fügen wir noch eine weitere Eingabesection für die <code>Location</code> hinzu mit einem Button und einem <code>spinner</code>, der anzeigen soll, dass etwas passiert. </p>
<p>Wir verwenden die CSS-Klassen und -Ids auch noch, um die Eingabe etwas "schöner" aussehen zu lassen und erweiteren dazu die <code>feed.css</code>:</p>
<div class="tabbed-set" data-tabs="2:1"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><label for="__tabbed_2_1">public/src/css/feed.css</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">#</span><span class="nn">create-post</span> <span class="p">{</span>
    <span class="k">z-index</span><span class="p">:</span> <span class="mi">1001</span><span class="p">;</span>
    <span class="k">position</span><span class="p">:</span> <span class="kc">fixed</span><span class="p">;</span>
    <span class="k">width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
<span class="hll">    <span class="k">min-height</span><span class="p">:</span> <span class="nb">calc</span><span class="p">(</span><span class="mi">100</span><span class="kt">vh</span> <span class="o">-</span> <span class="mi">56</span><span class="kt">px</span><span class="p">);</span>
</span>    <span class="k">overflow-y</span><span class="p">:</span> <span class="kc">scroll</span><span class="p">;</span>
    <span class="k">bottom</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">top</span><span class="p">:</span> <span class="mi">56</span><span class="kt">px</span><span class="p">;</span>
    <span class="k">background</span><span class="p">:</span> <span class="kc">white</span><span class="p">;</span>
    <span class="k">text-align</span><span class="p">:</span> <span class="kc">center</span><span class="p">;</span>
    <span class="c">/* visibility: hidden; */</span>
    <span class="k">transform</span><span class="p">:</span> <span class="nb">translateY</span><span class="p">(</span><span class="mi">100</span><span class="n">vH</span><span class="p">);</span>
    <span class="k">transition</span><span class="p">:</span> <span class="k">transform</span> <span class="mf">0.3</span><span class="kt">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="hll"><span class="p">#</span><span class="nn">create-post</span> <span class="nt">video</span><span class="o">,</span> <span class="p">#</span><span class="nn">create-post</span> <span class="nt">canvas</span> <span class="p">{</span>
</span><span class="hll">    <span class="k">width</span><span class="p">:</span> <span class="mi">512</span><span class="kt">px</span><span class="p">;</span>
</span><span class="hll">    <span class="k">max-width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
</span><span class="hll">    <span class="k">display</span><span class="p">:</span> <span class="kc">none</span><span class="p">;</span>
</span><span class="hll">    <span class="k">margin</span><span class="p">:</span> <span class="kc">auto</span><span class="p">;</span>
</span><span class="hll"><span class="p">}</span>
</span>
<span class="hll"><span class="p">#</span><span class="nn">create-post</span> <span class="p">#</span><span class="nn">pick-image</span> <span class="p">{</span>
</span><span class="hll">    <span class="k">display</span><span class="p">:</span> <span class="kc">none</span><span class="p">;</span>
</span><span class="hll"><span class="p">}</span>
</span>
<span class="hll"><span class="p">#</span><span class="nn">create-post</span> <span class="p">#</span><span class="nn">capture-btn</span> <span class="p">{</span>
</span><span class="hll">    <span class="k">margin</span><span class="p">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="kc">auto</span><span class="p">;</span>
</span><span class="hll"><span class="p">}</span>
</span>
<span class="hll"><span class="p">.</span><span class="nc">mdl-spinner</span> <span class="p">{</span>
</span><span class="hll">    <span class="k">margin</span><span class="p">:</span> <span class="kc">auto</span><span class="p">;</span>
</span><span class="hll"><span class="p">}</span>
</span>
<span class="c">/* hier der Rest */</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>Die CSS-Definitionen sorgen insbesondere dafür, dass das Video- , Canvas- und File-Picker-Element zunächst versteckt ist. </p>
<h2 id="dom-zugriff">DOM-Zugriff<a class="headerlink" href="#dom-zugriff" title="Permanent link">&para;</a></h2>
<p>Wir wollen uns zunächst darum kümmern, ein Live-Bild der Kamera in das Canvas-Element zu integrieren, d.h. wir kümmern uns zunächst um den Kamerazugriff. </p>
<h3 id="kamera">Kamera<a class="headerlink" href="#kamera" title="Permanent link">&para;</a></h3>
<p>Für den Kamerazugriff benötigen wir etwas JavaScript-Code. Wir erweitern die <code>feed.js</code>. Zunächst vereinfachen wir die Zugriffe auf die einzelnen Elemente und fügen eine Funktion hinzu, mit der wir den Zugriff auf die Kamera prüfen und herstellen wollen:</p>
<div class="tabbed-set" data-tabs="3:1"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><label for="__tabbed_3_1">public/src/js/feed.js</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">let</span> <span class="nx">shareImageButton</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#share-image-button&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">createPostArea</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#create-post&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">closeCreatePostModalButton</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#close-create-post-modal-btn&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">sharedMomentsArea</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#shared-moments&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">form</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">titleInput</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#title&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">locationInput</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#location&#39;</span><span class="p">);</span>
<span class="hll"><span class="kd">let</span> <span class="nx">videoPlayer</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#player&#39;</span><span class="p">);</span>
</span><span class="hll"><span class="kd">let</span> <span class="nx">canvasElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#canvas&#39;</span><span class="p">);</span>
</span><span class="hll"><span class="kd">let</span> <span class="nx">captureButton</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#capture-btn&#39;</span><span class="p">);</span>
</span><span class="hll"><span class="kd">let</span> <span class="nx">imagePicker</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#image-picker&#39;</span><span class="p">);</span>
</span><span class="hll"><span class="kd">let</span> <span class="nx">imagePickerArea</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#pick-image&#39;</span><span class="p">);</span>
</span>
<span class="hll"><span class="kd">function</span> <span class="nx">initializeMedia</span><span class="p">()</span> <span class="p">{</span>
</span><span class="hll">
</span><span class="hll"><span class="p">}</span>
</span>
<span class="kd">function</span> <span class="nx">openCreatePostModal</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">createPostArea</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">transform</span> <span class="o">=</span> <span class="s1">&#39;translateY(0)&#39;</span><span class="p">;</span>
<span class="hll">    <span class="nx">initializeMedia</span><span class="p">();</span>
</span><span class="p">}</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>In der neuen Funktion <code>initializeMedia()</code> wollen wir die <a href="https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices">MediaDevices</a>-API verwenden. Ein Blick in die <a href="https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices">Dokumentation</a> dieser API zeigt, dass die Browser-Unterstützung noch nicht besonders gut ist, zumindest für einige der Methoden darin. Wir wollen aber insbesondere die <code>getUserMedia()</code>-Funktion verwenden und dafür ist die Browser-Unterstützung wiederum doch <a href="https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia">sehr gut</a> (Chrom, Firefox, Edge und alle mobilen Geräte). </p>
<p>Für den Fall, dass die <code>MediaDevices</code>-API nicht unterstützt werden, erstellen wir uns im <code>navigator</code> ein eigenes <code>mediaDevices</code>-Objekt und prüfen, ob die <code>getUserMedia()</code>-Funktion unterstützt wird. Wenn dies nicht der Fall ist, erstellen wir uns für das neue <code>mediaDevices</code>-Objekt eine neue Eigenschaft <code>getUserDevices</code> und definieren es als eine Funktion. Diese Funktion nutzt dann <em>alte</em> Funktionen, die in den jeweiligen Browsern angeboten wurden (und werden). Wie gesagt, das ist nur ein <em>Fallback</em> für den Fall, dass ein Browser verwendet wird, der die <code>getUserMedia()</code>-Funktion in der <code>MediaDevices</code>-API <strong>nicht</strong> unterstützt (was, wie wir oben erläutert haben, nur noch selten der Fall ist). Wir erweitern für diesen seltenen Fall die <code>initializeMedia()</code>-Funktion:  </p>
<div class="tabbed-set" data-tabs="4:1"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><label for="__tabbed_4_1">public/src/js/feed.js</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">function</span> <span class="nx">initializeMedia</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;mediaDevices&#39;</span> <span class="k">in</span> <span class="nx">navigator</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">navigator</span><span class="p">.</span><span class="nx">mediaDevices</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;getUserMedia&#39;</span> <span class="k">in</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">mediaDevices</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">navigator</span><span class="p">.</span><span class="nx">mediaDevices</span><span class="p">.</span><span class="nx">getUserMedia</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">constraints</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">getUserMedia</span> <span class="o">=</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">webkitGetUserMedia</span> <span class="o">||</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">mozGetUserMedia</span><span class="p">;</span>

            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">getUserMedia</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;getUserMedia is not implemented&#39;</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="nx">getUserMedia</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">navigator</span><span class="p">,</span> <span class="nx">constraints</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
            <span class="p">})</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>Wenn also die <code>MediaDevices</code>-API nicht unterstützt wird (Zeile <code>15</code>), dann erstellen wir einen eigenes <code>MediaDevices</code>-Objekt (Zeile <code>16</code>). Für dieses eigene <code>MediaDevices</code>-Objekt erstellen wir eine <code>getUserMedia()</code>-Funktion (Zeile <code>20</code>). Diese Funktion gibt eine <code>Promise</code> zurück. Entweder, eine Promise mit dem Zustand <code>rejected</code> (Zeile <code>24</code>), nämlich genau dann, wenn der Browser auch nicht die <em>alten</em> Funktionen <code>webkitUserMedia</code> und <code>mozGetUserMedia</code> unterstützt. Dann können wir wirklich nichts mehr machen. Oder die Promise verwendet eine der beiden Funktionen und gibt die Promise nach Anwendung zurück - kann natürlich trotzdem noch sein, dass sie <code>rejected</code> wird, aber vielleicht auch <code>resolved</code>. Jedenfalls bezieht sich dieser gesamte Code auf den Fall, dass <code>getUserMedia()</code> in <code>navigator.mediaDevices</code> nicht unterstützt wird. Es handelt sich bei diesem Code um ein sogenanntes <a href="https://developer.mozilla.org/de/docs/Glossary/Polyfill">Polyfill</a>.</p>
<p>Wir kümmern uns jetzt darum, tatsächlich Zugriff zur Kamera zu bekommen. Das kann nun entweder über die <em>moderne</em> <code>getUserMedia()</code>-Funktion aus <code>navigator.mediaDevices</code> geschehen oder über das <em>Polyfill</em> unter Verwendung von <code>webkitGetUserMedia()</code> oder <code>mozGetUserMedia()</code>. Nur für den Fall, dass wir keinen Zugriff auf die Kamera erhalten, wollen wir den <code>File-Picker</code> verwenden, um eine Bilddatei hochzuladen. </p>
<div class="tabbed-set" data-tabs="5:1"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><label for="__tabbed_5_1">public/src/js/feed.js</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">function</span> <span class="nx">initializeMedia</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;mediaDevices&#39;</span> <span class="k">in</span> <span class="nx">navigator</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">navigator</span><span class="p">.</span><span class="nx">mediaDevices</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;getUserMedia&#39;</span> <span class="k">in</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">mediaDevices</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">navigator</span><span class="p">.</span><span class="nx">mediaDevices</span><span class="p">.</span><span class="nx">getUserMedia</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">constraints</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">getUserMedia</span> <span class="o">=</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">webkitGetUserMedia</span> <span class="o">||</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">mozGetUserMedia</span><span class="p">;</span>

            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">getUserMedia</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;getUserMedia is not implemented&#39;</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="nx">getUserMedia</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">navigator</span><span class="p">,</span> <span class="nx">constraints</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
            <span class="p">})</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="hll">    <span class="nx">navigator</span><span class="p">.</span><span class="nx">mediaDevices</span><span class="p">.</span><span class="nx">getUserMedia</span><span class="p">({</span><span class="nx">video</span><span class="o">:</span> <span class="kc">true</span><span class="p">})</span>
</span><span class="hll">        <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">stream</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class="hll">            <span class="nx">videoPlayer</span><span class="p">.</span><span class="nx">srcObject</span> <span class="o">=</span> <span class="nx">stream</span><span class="p">;</span>
</span><span class="hll">            <span class="nx">videoPlayer</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;block&#39;</span><span class="p">;</span>
</span><span class="hll">        <span class="p">})</span>
</span><span class="hll">        <span class="p">.</span><span class="k">catch</span><span class="p">(</span> <span class="nx">err</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class="hll">            <span class="nx">imagePickerArea</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;block&#39;</span><span class="p">;</span>
</span><span class="hll">        <span class="p">});</span>
</span><span class="p">}</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>An Zeile <code>32</code> können wir auf jeden Fall auf die <code>getUserMedia()</code>-Funktion zugreifen und genau das tun wir auch in Zeile <code>33</code>. Dieser Funktion wird ein JavaScript-Objekt übergeben. Dieses Objekt hat zwei Eigenschaften: <code>video</code> und <code>audio</code>. Beide sind auf <code>false</code> gesetzt, wir können sie jedoch mit <code>true</code> einschalten und erledigen das für <code>video</code> ebefalls in Zeile <code>33</code>. Diese Funktion gibt eine <code>promise</code> zurück. Im <code>resolve</code>-Fall erhalten wir einen Video- und/oder Audio-<code>Stream</code>. Wir verwenden diesen <code>stream</code> als Quelle für unseren Videplayer (der aufgrund der Funktion <code>autoplay</code> den Stream sofort anzeigt). Wir setzen dafür den Videoplayer auf sichtbar - <code>display: 'block'</code>. </p>
<p>Der <code>reject</code>-Fall der Promise kann verschiedene Gründe haben. Ein Grund wäre, wie oben erläutert, dass wir selbst mit dem <em>Polyfill</em> keinen Zugriff auf die Kamera bekommen. Ein anderer wäre, dass unser Gerät gar nicht mit einer Kamera verbunden ist und ein dritter Fall wäre, dass der Zugriff auf die Kamera von der Nutzerin blockiert wird. Wenn die <code>getUserMedia()</code>-Funktion das erste Mal aufgerufen wird, erfolgt eine Abfrage, ob der Zugriff auf die Kamera zugelassen oder blockiert wird:</p>
<p><img alt="devices" src="../files/82_devices.png" /></p>
<p>Die Entscheidung lässt sich auch nachträglich ändern, indem man auf das <code>i</code> links neben der URL klickt. Wenn Sie die Anwendung ausführen und den Zugriff auf die Kamera erlauben, wird das Video sofort angezeigt.</p>
<p><img alt="devices" src="../files/83_devices.png" /></p>
<p>Wird die Promise <code>rejected</code>, soll die gesamte <code>imagePickerArea</code> (wieder) auf <code>display: 'block'</code> gesetzt werden. In der Funktion <code>closeCreatePostModal()</code> setzen wir die Video- und File-Picker-Elemente ebenaflls alle (wieder) auf <code>display: 'block'</code>. </p>
<div class="tabbed-set" data-tabs="6:1"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><label for="__tabbed_6_1">public/src/js/feed.js</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>48
49
50
51
52
53</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">function</span> <span class="nx">closeCreatePostModal</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">createPostArea</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">transform</span> <span class="o">=</span> <span class="s1">&#39;translateY(100vH)&#39;</span><span class="p">;</span>
<span class="hll">    <span class="nx">imagePickerArea</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
</span><span class="hll">    <span class="nx">videoPlayer</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
</span><span class="hll">    <span class="nx">canvasElement</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
</span><span class="p">}</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>Wird der Zugriff auf die Kamera blockiert, wird stattdessen der File-Picker angezeigt: </p>
<p><img alt="devices" src="../files/84_devices.png" /></p>
<p>Nun wollen wir den <code>Foto</code>-Button implementieren, damit wir ein Foto von dem Kamerastream erzeugen können. Dazu implementieren wir für diesen Button die Behandlung des <code>click</code>-Ereignisses:</p>
<div class="tabbed-set" data-tabs="7:1"><input checked="checked" id="__tabbed_7_1" name="__tabbed_7" type="radio" /><label for="__tabbed_7_1">public/src/js/feed.js</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>43
44
45
46
47
48
49
50
51
52</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nx">captureButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">event</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">canvasElement</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;block&#39;</span><span class="p">;</span>
    <span class="nx">videoPlayer</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
    <span class="nx">captureButton</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">context</span> <span class="o">=</span> <span class="nx">canvasElement</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">videoPlayer</span><span class="p">,</span> <span class="mf">0</span><span class="p">,</span> <span class="mf">0</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">videoPlayer</span><span class="p">.</span><span class="nx">videoHeight</span> <span class="o">/</span> <span class="p">(</span><span class="nx">videoPlayer</span><span class="p">.</span><span class="nx">videoWidth</span> <span class="o">/</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">));</span>
    <span class="nx">videoPlayer</span><span class="p">.</span><span class="nx">srcObject</span><span class="p">.</span><span class="nx">getVideoTracks</span><span class="p">().</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">track</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">track</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
    <span class="p">})</span>
<span class="p">});</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>Die Grundidee dabei ist die, dass wir das ktuelle Bild des <code>videoPlayers</code> in unser <code>canvasElement</code> einfügen, das <code>canvasElement</code> sichtbar gestalten, den <code>videoPlayer</code> unsichtbar (und den Button dann auch gleich noch) und außerdem den Videoplayer stoppen. </p>
<p>Das <code>Canvas</code>-Element verfügt über einen Grafikkontext, den wir in Zeile <code>52</code> als <code>2d</code> auswählen. Siehe dazu auch <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLCanvasElement/getContext">HTMLCanvasElement.getContext()</a>. Für diesen <code>context</code> rufen wir die <code>drawImage()</code>-Funktion auf (siehe <a href="https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/drawImage">CanvasRenderingContext2D.drawImage()</a>). </p>
<ul>
<li>der erste Parameter der <code>drawImage()</code>-Funktion ist das Bild. Wir übergeben dazu den <code>videoPlayer</code>. </li>
<li>der zweite und dritte Parameter ist die Koordinate des linken oberen Punktes innerhalb des Canvas-Elementes, hier <code>x=0</code> und <code>y= 0</code>.</li>
<li>der dritte Parameter gibt die Breite des Bildes an. Wir nehmen hier die gesamte Breite des Canvas-Elementes.</li>
<li>der vierte Parameter gibt die Höhe des Bildes an. Da wir der Breite einen festen Wert zugewiesen haben (die Canvas-Breite), müssen wir die Höhe in Abhängigkeit der Relation des Videos berechnen. </li>
</ul>
<p>Wenn wir dieses Bild erstellt haben, können wir den Videoplayer stoppen. Die Funktion <code>getVideoTracks()</code> gibt ein Array allerlaufenden Streams auf der Webseite zurück. Wir laufen durch dieses Array mithilfe der <code>forEach</code>-Schleife (Zeile <code>54</code>) und stoppen alle laufenden Streams (Zeile <code>55</code>). </p>
<p>Wenn wir nun den <code>Foto</code>-Button klicken, sehen wir das (Stand-)Bild im <code>canvasElement</code>, der <code>videoPlayer</code> und der Button sind unsichtbar und der <code>videoPlayer</code> ist gestoppt. </p>
<h3 id="speichern-des-bildes-im-backend">Speichern des Bildes im Backend<a class="headerlink" href="#speichern-des-bildes-im-backend" title="Permanent link">&para;</a></h3>
<p>Das so aufgenommene Foto wollen wir nun im Backend speichern. Dafür ist im Backend zum Glück schon alles vorbereitet. Das Bild ist jetzt im Canvas, wir müssen es noch in einen <code>`base64String</code> umwandeln. Wir definieren uns zwei neue Funktionen. Die eine wandelt das Bild in das <code>blob</code>-Format um. Das könnte man auch schon in die Datenbank speichern, aber wir haben das Backend so geschrieben, dass es einen <code>base64String</code> erwartet. Deswegen wandeln wir das <code>blob</code>-Format auch noch in diesen <code>base64String</code> um. Wir verwenden dazu jeweils Funktionen, die man im Netz findet. Ich habe diese jetzt zusammen mit der <code>urlBase64ToUint8Array(base64String)</code>-Funktion aus dem vorherigen Kapitel in eine eigene <code>utility.js</code>-Datei gepackt, um die Funktionen etwas besser zu strukturieren. Hier die neue Datei mit den neuen Funktion <code>dataURItoBlob(dataURI)</code> und <code>blobToBase64</code> und der alten <code>urlBase64ToUint8Array(base64String)</code>, die ich aus <code>app.js</code> entfernt und <strong>hierher verschoben</strong> habe. </p>
<div class="tabbed-set" data-tabs="8:1"><input checked="checked" id="__tabbed_8_1" name="__tabbed_8" type="radio" /><label for="__tabbed_8_1">public/src/js/utility.js</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">function</span> <span class="nx">urlBase64ToUint8Array</span><span class="p">(</span><span class="nx">base64String</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">padding</span> <span class="o">=</span> <span class="s1">&#39;=&#39;</span><span class="p">.</span><span class="nx">repeat</span><span class="p">((</span><span class="mf">4</span> <span class="o">-</span> <span class="nx">base64String</span><span class="p">.</span><span class="nx">length</span> <span class="o">%</span> <span class="mf">4</span><span class="p">)</span> <span class="o">%</span> <span class="mf">4</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">base64</span> <span class="o">=</span> <span class="p">(</span><span class="nx">base64String</span> <span class="o">+</span> <span class="nx">padding</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\-/g</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/_/g</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">rawData</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">atob</span><span class="p">(</span><span class="nx">base64</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">outputArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">rawData</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">rawData</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">outputArray</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rawData</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">outputArray</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">dataURItoBlob</span><span class="p">(</span><span class="nx">dataURI</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">byteString</span> <span class="o">=</span> <span class="nx">atob</span><span class="p">(</span><span class="nx">dataURI</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mf">1</span><span class="p">]);</span>
  <span class="kd">var</span> <span class="nx">mimeString</span> <span class="o">=</span> <span class="nx">dataURI</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mf">0</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mf">1</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span>
  <span class="kd">var</span> <span class="nx">ab</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="nx">byteString</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">ia</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">ab</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">byteString</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ia</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">byteString</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="nx">ab</span><span class="p">],</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="nx">mimeString</span><span class="p">});</span>
  <span class="k">return</span> <span class="nx">blob</span><span class="p">;</span>
<span class="p">}</span>


<span class="kd">const</span> <span class="nx">blobToBase64</span> <span class="o">=</span> <span class="nx">blob</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
  <span class="nx">reader</span><span class="p">.</span><span class="nx">readAsDataURL</span><span class="p">(</span><span class="nx">blob</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">reader</span><span class="p">.</span><span class="nx">onloadend</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">resolve</span><span class="p">(</span><span class="nx">reader</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">});</span>
<span class="p">};</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>Die <code>blobToBase64</code> ist als Promise definiert. Die neue Datei <code>utility.js</code> muss nun in die <code>index.html</code> eingebettet werden:</p>
<div class="tabbed-set" data-tabs="9:1"><input checked="checked" id="__tabbed_9_1" name="__tabbed_9" type="radio" /><label for="__tabbed_9_1">public/index.html</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>117
118
119
120
121
122</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">script</span> <span class="na">defer</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;/src/js/material.min.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;/src/js/idb.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;/src/js/db.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="hll"><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;/src/js/utility.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;/src/js/app.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;/src/js/feed.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>Mit diesen Hilfsfunktionen sind die Anpassungen recht logisch, die wir nun vornehmen müssen, um die Daten in das Backend zu speichern. </p>
<p>In der <code>feed.js</code> erstellen wir uns für den <code>base64String</code> eine globale Variable und weisen dieser den entsprechenden Wert zu, sobald wir das Foto aufgemommen haben: </p>
<div class="tabbed-set" data-tabs="10:1"><input checked="checked" id="__tabbed_10_1" name="__tabbed_10" type="radio" /><label for="__tabbed_10_1">public/src/js/feed.js</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">let</span> <span class="nx">shareImageButton</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#share-image-button&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">createPostArea</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#create-post&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">closeCreatePostModalButton</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#close-create-post-modal-btn&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">sharedMomentsArea</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#shared-moments&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">form</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">titleInput</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#title&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">locationInput</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#location&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">videoPlayer</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#player&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">canvasElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#canvas&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">captureButton</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#capture-btn&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">imagePicker</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#image-picker&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">imagePickerArea</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#pick-image&#39;</span><span class="p">);</span>
<span class="hll"><span class="kd">let</span> <span class="nx">base64String</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span>
<span class="kd">function</span> <span class="nx">initializeMedia</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;mediaDevices&#39;</span> <span class="k">in</span> <span class="nx">navigator</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">navigator</span><span class="p">.</span><span class="nx">mediaDevices</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;getUserMedia&#39;</span> <span class="k">in</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">mediaDevices</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">navigator</span><span class="p">.</span><span class="nx">mediaDevices</span><span class="p">.</span><span class="nx">getUserMedia</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">constraints</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">getUserMedia</span> <span class="o">=</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">webkitGetUserMedia</span> <span class="o">||</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">mozGetUserMedia</span><span class="p">;</span>

            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">getUserMedia</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;getUserMedia is not implemented&#39;</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="nx">getUserMedia</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">navigator</span><span class="p">,</span> <span class="nx">constraints</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
            <span class="p">})</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">navigator</span><span class="p">.</span><span class="nx">mediaDevices</span><span class="p">.</span><span class="nx">getUserMedia</span><span class="p">({</span><span class="nx">video</span><span class="o">:</span> <span class="kc">true</span><span class="p">})</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">stream</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">videoPlayer</span><span class="p">.</span><span class="nx">srcObject</span> <span class="o">=</span> <span class="nx">stream</span><span class="p">;</span>
            <span class="nx">videoPlayer</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;block&#39;</span><span class="p">;</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="k">catch</span><span class="p">(</span> <span class="nx">err</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">imagePickerArea</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;block&#39;</span><span class="p">;</span>
        <span class="p">});</span>
<span class="p">}</span>

<span class="nx">captureButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">event</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">canvasElement</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;block&#39;</span><span class="p">;</span>
    <span class="nx">videoPlayer</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
    <span class="nx">captureButton</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">context</span> <span class="o">=</span> <span class="nx">canvasElement</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">videoPlayer</span><span class="p">,</span> <span class="mf">0</span><span class="p">,</span> <span class="mf">0</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">videoPlayer</span><span class="p">.</span><span class="nx">videoHeight</span> <span class="o">/</span> <span class="p">(</span><span class="nx">videoPlayer</span><span class="p">.</span><span class="nx">videoWidth</span> <span class="o">/</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">));</span>
    <span class="nx">videoPlayer</span><span class="p">.</span><span class="nx">srcObject</span><span class="p">.</span><span class="nx">getVideoTracks</span><span class="p">().</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">track</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">track</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
    <span class="p">});</span>
<span class="hll">    <span class="kd">let</span> <span class="nx">picture</span> <span class="o">=</span> <span class="nx">dataURItoBlob</span><span class="p">(</span><span class="nx">canvasElement</span><span class="p">.</span><span class="nx">toDataURL</span><span class="p">());</span>
</span><span class="hll">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;picture&#39;</span><span class="p">,</span> <span class="nx">picture</span><span class="p">);</span>
</span><span class="hll">    <span class="nx">blobToBase64</span><span class="p">(</span><span class="nx">picture</span><span class="p">)</span>
</span><span class="hll">        <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">res</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class="hll">            <span class="kd">let</span> <span class="nx">base64StringWithTag</span> <span class="o">=</span> <span class="nx">res</span><span class="p">;</span>
</span><span class="hll">            <span class="nx">base64String</span> <span class="o">=</span> <span class="nx">base64StringWithTag</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">base64StringWithTag</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="o">+</span><span class="mf">1</span><span class="p">)</span>
</span><span class="hll">            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;base64String&#39;</span><span class="p">,</span> <span class="nx">base64String</span><span class="p">);</span>
</span><span class="hll">            <span class="p">}</span>
</span><span class="hll">        <span class="p">)</span>
</span><span class="p">});</span>

<span class="kd">function</span> <span class="nx">openCreatePostModal</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">createPostArea</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">transform</span> <span class="o">=</span> <span class="s1">&#39;translateY(0)&#39;</span><span class="p">;</span>
    <span class="nx">initializeMedia</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">closeCreatePostModal</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">createPostArea</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">transform</span> <span class="o">=</span> <span class="s1">&#39;translateY(100vH)&#39;</span><span class="p">;</span>
    <span class="nx">imagePickerArea</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
    <span class="nx">videoPlayer</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
    <span class="nx">canvasElement</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">shareImageButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">openCreatePostModal</span><span class="p">);</span>

<span class="nx">closeCreatePostModalButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">closeCreatePostModal</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">clearCards</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">sharedMomentsArea</span><span class="p">.</span><span class="nx">hasChildNodes</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">sharedMomentsArea</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">sharedMomentsArea</span><span class="p">.</span><span class="nx">lastChild</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">createCard</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">cardWrapper</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
    <span class="nx">cardWrapper</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">&#39;shared-moment-card mdl-card mdl-shadow--2dp&#39;</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">cardTitle</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
    <span class="nx">cardTitle</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">&#39;mdl-card__title&#39;</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">image</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Image</span><span class="p">();</span>
    <span class="nx">image</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s2">&quot;data:image/png;base64,&quot;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">image</span><span class="p">;</span>
    <span class="nx">cardTitle</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundImage</span> <span class="o">=</span> <span class="s1">&#39;url(&#39;</span> <span class="o">+</span> <span class="nx">image</span><span class="p">.</span><span class="nx">src</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">;</span>
    <span class="nx">cardTitle</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundSize</span> <span class="o">=</span> <span class="s1">&#39;cover&#39;</span><span class="p">;</span>
    <span class="nx">cardWrapper</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">cardTitle</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">cardTitleTextElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;h2&#39;</span><span class="p">);</span>
    <span class="nx">cardTitleTextElement</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">&#39;mdl-card__title-text whiteText&#39;</span><span class="p">;</span>
    <span class="nx">cardTitleTextElement</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
    <span class="nx">cardTitle</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">cardTitleTextElement</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">cardSupportingText</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
    <span class="nx">cardSupportingText</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">&#39;mdl-card__supporting-text&#39;</span><span class="p">;</span>
    <span class="nx">cardSupportingText</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">location</span><span class="p">;</span>
    <span class="nx">cardSupportingText</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">textAlign</span> <span class="o">=</span> <span class="s1">&#39;center&#39;</span><span class="p">;</span>
    <span class="nx">cardWrapper</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">cardSupportingText</span><span class="p">);</span>
    <span class="nx">componentHandler</span><span class="p">.</span><span class="nx">upgradeElement</span><span class="p">(</span><span class="nx">cardWrapper</span><span class="p">);</span>
    <span class="nx">sharedMomentsArea</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">cardWrapper</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">updateUI</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">post</span> <span class="k">of</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">createCard</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nx">networkDataReceived</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

<span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;http://localhost:3000/posts&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">networkDataReceived</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;From backend ...&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
        <span class="nx">updateUI</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="p">});</span>

<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;indexedDB&#39;</span> <span class="k">in</span> <span class="nb">window</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">readAllData</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">networkDataReceived</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;From cache ...&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
                <span class="nx">updateUI</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">})</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">sendDataToBackend</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;http://localhost:3000/posts&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
        <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Accept&#39;</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="nx">body</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
            <span class="nx">id</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">title</span><span class="o">:</span> <span class="nx">titleInput</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span>
            <span class="nx">location</span><span class="o">:</span> <span class="nx">locationInput</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span>
<span class="hll">            <span class="nx">image</span><span class="o">:</span> <span class="nx">base64String</span><span class="p">,</span>
</span>            <span class="p">})</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">response</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Data sent to backend ...&#39;</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">data</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;data ...&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
        <span class="nx">updateUI</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
    <span class="p">});</span>
<span class="p">}</span>


<span class="nx">form</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;submit&#39;</span><span class="p">,</span> <span class="nx">event</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span> <span class="c1">// nicht absenden und neu laden</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39; in submit !&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">titleInput</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span> <span class="o">||</span> <span class="nx">locationInput</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;Bitte Titel und Location angeben!&#39;</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">closeCreatePostModal</span><span class="p">();</span>

    <span class="k">if</span><span class="p">(</span><span class="s1">&#39;serviceWorker&#39;</span> <span class="k">in</span> <span class="nx">navigator</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;SyncManager&#39;</span> <span class="k">in</span> <span class="nb">window</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">navigator</span><span class="p">.</span><span class="nx">serviceWorker</span><span class="p">.</span><span class="nx">ready</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">sw</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="nx">post</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="nx">id</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
                    <span class="nx">title</span><span class="o">:</span> <span class="nx">titleInput</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span>
                    <span class="nx">location</span><span class="o">:</span> <span class="nx">locationInput</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span>
<span class="hll">                    <span class="nx">image</span><span class="o">:</span> <span class="nx">base64String</span>
</span>                <span class="p">};</span>
                <span class="nx">writeData</span><span class="p">(</span><span class="s1">&#39;sync-posts&#39;</span><span class="p">,</span> <span class="nx">post</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">sw</span><span class="p">.</span><span class="nx">sync</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">&#39;sync-new-post&#39;</span><span class="p">);</span>
                    <span class="p">})</span>
                    <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
                        <span class="kd">let</span> <span class="nx">snackbarContainer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MaterialSnackbar</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#confirmation-toast&#39;</span><span class="p">));</span>
                        <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;Eingaben zum Synchronisieren gespeichert!&#39;</span><span class="p">,</span> <span class="nx">timeout</span><span class="o">:</span> <span class="mf">1000</span><span class="p">};</span>
                        <span class="nx">snackbarContainer</span><span class="p">.</span><span class="nx">showSnackbar</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
                    <span class="p">});</span>
            <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">sendDataToBackend</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>In Zeile <code>13</code> ist die Deklaration der globalen Variablen. In den Zeilen <code>53-61</code> wird das Bild in einen <code>base64String</code> umgewandelt (unter Verwendung der neuen Funktionen aus der <code>utility.js</code>). Für das Senden der Daten an das Backend wird nun für die <code>image</code>-Eigenschaft der Wert aus der globalen Variablen gelesen und das Gleiche passiert, wenn wir das Bild in die IndexedDB speichern, um es per Hintergrundsynchronisation an das Backend zu senden. </p>
<p>Bei der Behandlung des <code>sync</code>-Events im Service Worker lesen wir nun auch diesen Wert für die <code>image</code>-Eigenschaft aus: </p>
<div class="tabbed-set" data-tabs="11:1"><input checked="checked" id="__tabbed_11_1" name="__tabbed_11" type="radio" /><label for="__tabbed_11_1">public/sw.js</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nx">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;sync&#39;</span><span class="p">,</span> <span class="nx">event</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;service worker --&gt; background syncing ...&#39;</span><span class="p">,</span> <span class="nx">event</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">tag</span> <span class="o">===</span> <span class="s1">&#39;sync-new-post&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;service worker --&gt; syncing new posts ...&#39;</span><span class="p">);</span>
        <span class="nx">event</span><span class="p">.</span><span class="nx">waitUntil</span><span class="p">(</span>
            <span class="nx">readAllData</span><span class="p">(</span><span class="s1">&#39;sync-posts&#39;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">dataArray</span> <span class="p">=&gt;</span> <span class="p">{</span>
                    <span class="k">for</span><span class="p">(</span><span class="kd">let</span> <span class="nx">data</span> <span class="k">of</span> <span class="nx">dataArray</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;data from IndexedDB&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
                        <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;http://localhost:3000/posts&#39;</span><span class="p">,</span> <span class="p">{</span>
                            <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
                            <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
                                <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;Accept&#39;</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
                            <span class="p">},</span>
                            <span class="nx">body</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
                                <span class="nx">id</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
                                <span class="nx">title</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span>
                                <span class="nx">location</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">location</span><span class="p">,</span>
<span class="hll">                                <span class="nx">image</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">image</span><span class="p">,</span>
</span>                            <span class="p">})</span>
                        <span class="p">})</span>
                        <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">response</span> <span class="p">=&gt;</span> <span class="p">{</span>
                            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Data sent to backend ...&#39;</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
                            <span class="k">if</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">deleteOneData</span><span class="p">(</span><span class="s1">&#39;sync-posts&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
                            <span class="p">}</span>
                        <span class="p">})</span>
                        <span class="p">.</span><span class="k">catch</span><span class="p">(</span> <span class="nx">err</span> <span class="p">=&gt;</span> <span class="p">{</span>
                            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Error while sending data to backend ...&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
                        <span class="p">})</span>
                    <span class="p">}</span>
                <span class="p">})</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">})</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>Das war es schon, wir können nun die Daten an das Backend senden. Zum Testen nehmen Sie ein Foto auf, geben einen Titel und eine Location ein und klicken den <code>Speichern</code>-Button. Dann lednet - hoffentlich - alles im Backend (über den "Umweg" IndexedDB natürlich). Sie erhalten auch eine Push-Nachricht, dass die Daten gespeichert wurden. </p>
<p>Wir implementieren nun noch den Fall, dass die Kamera nicht zur Verfügung steht oder die <code>MediaDevices</code>-API oder der Kamerazugriff blockiert wurde und ermöglichen dafür das Hochladen einer Bilddatei. </p>
<h3 id="bilddatei-hochladen">Bilddatei hochladen<a class="headerlink" href="#bilddatei-hochladen" title="Permanent link">&para;</a></h3>
<p>Das Hochladen einer Bilddatei kennen wir ja bereits von unserem anderen Frontend. Hier ist nun auch schon alles vorbereitet und wir müssen in der <code>feed.js</code> nur noch das <code>change</code>-Event für den <code>upload</code>-Button behandeln. Das sieht im Prinzip genau so aus, wie die Umwandlung des Canvas-Bildes, nur dass <code>picture</code> hier die hochgeladene Datei ist: </p>
<div class="tabbed-set" data-tabs="12:1"><input checked="checked" id="__tabbed_12_1" name="__tabbed_12" type="radio" /><label for="__tabbed_12_1">public/src/js/feed.js</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>104
105
106
107
108
109
110
111
112
113</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nx">imagePicker</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="nx">event</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">picture</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="mf">0</span><span class="p">];</span>
    <span class="nx">blobToBase64</span><span class="p">(</span><span class="nx">picture</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">res</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="nx">base64StringWithTag</span> <span class="o">=</span> <span class="nx">res</span><span class="p">;</span>
                <span class="nx">base64String</span> <span class="o">=</span> <span class="nx">base64StringWithTag</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">base64StringWithTag</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="o">+</span><span class="mf">1</span><span class="p">)</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;base64String&#39;</span><span class="p">,</span> <span class="nx">base64String</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">)</span>
<span class="p">});</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>Zum Testen muss im Browser links von der URL auf das <code>i</code> geklickt und Kamera <code>blockieren</code> ausgewählt werden. dann öffnet sich der File-Picker. </p>
<h2 id="geolocation-api">Geolocation-API<a class="headerlink" href="#geolocation-api" title="Permanent link">&para;</a></h2>
<p>Die Geolocation-API wird von allen Browsern unterstützt (sogar Internet Explorer). Es gibt viele Dokumentationen darüber, z.B. <a href="https://developer.mozilla.org/en-US/docs/Web/API/Geolocation">hier</a>, <a href="https://developer.mozilla.org/de/docs/Web/API/Geolocation_API">hier</a> und <a href="https://developers.google.com/maps/documentation/geolocation/overview">hier</a>. Die Verwendung ist recht einfach. </p>
<p>In der <code>index.html</code> haben wir uns bereits einen Button erstellt, für den wir "nur noch" das <code>click</code>-Ereignis behandeln müssen. </p>
<div class="tabbed-set" data-tabs="13:1"><input checked="checked" id="__tabbed_13_1" name="__tabbed_13" type="radio" /><label for="__tabbed_13_1">public/index.html</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>83
84
85
86</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;input-section&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;mdl-button mdl-js-button mdl-button--colored&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;button&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;location-btn&quot;</span><span class="p">&gt;</span>Location<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;mdl-spinner mdl-js-spinner is-active&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;location-loader&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>Zunächst vereinfachen wir uns in der <code>feed.js</code> wieder den Zugriff auf den Button und den Spinner (Loader) und erstellen noch eine globale Variable <code>fetchedLocation</code>:</p>
<div class="tabbed-set" data-tabs="14:1"><input checked="checked" id="__tabbed_14_1" name="__tabbed_14" type="radio" /><label for="__tabbed_14_1">public/src/js/feed.js</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">let</span> <span class="nx">shareImageButton</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#share-image-button&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">createPostArea</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#create-post&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">closeCreatePostModalButton</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#close-create-post-modal-btn&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">sharedMomentsArea</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#shared-moments&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">form</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">titleInput</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#title&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">locationInput</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#location&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">videoPlayer</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#player&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">canvasElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#canvas&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">captureButton</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#capture-btn&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">imagePicker</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#image-picker&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">imagePickerArea</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#pick-image&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">base64String</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="hll"><span class="kd">let</span> <span class="nx">locationButton</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#location-btn&#39;</span><span class="p">);</span>
</span><span class="hll"><span class="kd">let</span> <span class="nx">locationLoader</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#location-loader&#39;</span><span class="p">);</span>
</span><span class="hll"><span class="kd">let</span> <span class="nx">fetchedLocation</span><span class="p">;</span>
</span></code></pre></div>
</td></tr></table>
</div>
</div>
<p>und wir setzen den <code>Loader</code> in der <code>feed.css</code> auf unsichtbar:</p>
<div class="tabbed-set" data-tabs="15:1"><input checked="checked" id="__tabbed_15_1" name="__tabbed_15" type="radio" /><label for="__tabbed_15_1">public/src/js/feed.css</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="hll"><span class="p">#</span><span class="nn">create-post</span> <span class="p">#</span><span class="nn">pick-image</span><span class="o">,</span> <span class="p">#</span><span class="nn">create-post</span> <span class="p">#</span><span class="nn">location-loader</span> <span class="p">{</span>
</span>    <span class="k">display</span><span class="p">:</span> <span class="kc">none</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p><code>create-post #pick-image</code> stand dort schon, wir haben nur noch den Selektor <code>#create-post #location-loader</code> hinzugefügt.</p>
<p>Wir fügen in der <code>feed.js</code> die Behandlung des <code>click</code>-Ereignisses für den <code>Location</code>-Button hinzu und auch noch, wie für die Kamera, eine <code>initializeLocation()</code>-Funktion, in der geprüft wird, ob die <code>Geolocation</code>-API überhaupt im Browser verfügbar ist: </p>
<div class="tabbed-set" data-tabs="16:1"><input checked="checked" id="__tabbed_16_1" name="__tabbed_16" type="radio" /><label for="__tabbed_16_1">public/src/js/feed.js</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nx">locationButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">event</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;geolocation&#39;</span> <span class="k">in</span> <span class="nx">navigator</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">locationButton</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
    <span class="nx">locationLoader</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;block&#39;</span><span class="p">;</span>

    <span class="nx">navigator</span><span class="p">.</span><span class="nx">geolocation</span><span class="p">.</span><span class="nx">getCurrentPosition</span><span class="p">(</span> <span class="nx">position</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">locationButton</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;inline&#39;</span><span class="p">;</span>
        <span class="nx">locationLoader</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
        <span class="nx">fetchedLocation</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">latitude</span><span class="o">:</span> <span class="nx">position</span><span class="p">.</span><span class="nx">coords</span><span class="p">.</span><span class="nx">latitude</span><span class="p">,</span> <span class="nx">longitude</span><span class="o">:</span> <span class="nx">position</span><span class="p">.</span><span class="nx">coords</span><span class="p">.</span><span class="nx">longitude</span> <span class="p">};</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;current position: &#39;</span><span class="p">,</span> <span class="nx">fetchedLocation</span><span class="p">);</span>
        <span class="nx">locationInput</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s1">&#39;In Berlin&#39;</span><span class="p">;</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#manual-location&#39;</span><span class="p">).</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;is-focused&#39;</span><span class="p">);</span>
    <span class="p">},</span> <span class="nx">err</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="nx">locationButton</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;inline&#39;</span><span class="p">;</span>
        <span class="nx">locationLoader</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;Couldn\&#39;t fetch location, please enter manually!&#39;</span><span class="p">);</span>
        <span class="nx">fetchedLocation</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">},</span> <span class="p">{</span> <span class="nx">timeout</span><span class="o">:</span> <span class="mf">5000</span><span class="p">});</span>
<span class="p">});</span>

<span class="kd">function</span> <span class="nx">initializeLocation</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s1">&#39;geolocation&#39;</span> <span class="k">in</span> <span class="nx">navigator</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">locationButton</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>In der <code>initializeLocation()</code>-Funktion wird geprüft, ob der Browser die <code>Geolocation</code>-API unterstützt. Wenn nicht, wird der <code>Location</code>-Button versteckt. Wir haben trotzdem, sicherheitshalber, die Abfrage nochmal in die Behandlung des <code>click</code>-Ereignisses für diesen Button eingefügt (Zeilen <code>19-20</code>), obwohl dies nicht wirklich notwendig ist, da der Button nicht angeklickt werden kann, wenn die <code>Geolocation</code>-API nicht unterstützt wird, da er nicht angezeigt wird. </p>
<p>Wenn auf den Button geklickt wurde, setzen wir den Button selbst auf unsichtbar (Zeile <code>23</code>) und den Spinner (Loader) auf sichtbar (Zeile <code>24</code>). Zeile <code>26</code> zeigt den eigentlichen Zugriff auf die aktuelle Position. Dort wird die Funktion <code>getCurrentPosition()</code> der <code>Geolocation</code>-API aufgerufen. Wir übergeben drei Parameter:</p>
<ul>
<li>der erste Parameter ist die (Callback-)Funktion, die die aktuelle Position zurückgibt. Wenn diese Funktion ausgeführt wird, setzen wir den Button wieder auf sichtbar (Zeile <code>27</code>) und den Loader auf unsichtbar (Zeile <code>28</code>). Die aktuelle Position <code>position</code> enthält die Eigenschaft <code>coords</code>, die die <code>latitude</code> und <code>longitude</code> als Werte enthält (siehe <a href="https://developer.mozilla.org/en-US/docs/Web/API/GeolocationPosition">GeolocationPosition</a> und <a href="https://developer.mozilla.org/en-US/docs/Web/API/GeolocationCoordinates">GeolocationPosition</a>).  Diese Position geben wir auf der Konsole aus (Zeile <code>30</code>). Wir befüllen das <code>locationInput</code>-Eingabefeld noch mit einem Dummy-Wert und fokussieren auf das Eingabefeld (Zeilen <code>31-32</code>).</li>
<li>der zweite Parameter ist eine Funktion, die ausgeführt wird, wenn ein Fehler auftritt. Mögliche Fehler sind, dass im Browser der Zugriff auf die Position deaktiviert wurde, dass die Nutzerin den Zugriff auf die aktuelle Position blockiert hat oder dass die Position nicht "schnell genug" ermittelt werden konnte. Im Fehlerfall geben wir den Fehler auf der Konsole aus und schalten den Button wieder ein und den Loader wieder aus (Zeilen <code>34-36</code>).</li>
<li>der dritte Parameter ist ein JavaScript-Objekt mit <code>options</code>. Wir wählen hier nur eine einzige Option, nämlich wie lange nach der aktuellen Position gesucht werden soll. In der Einstellung erfolgt der <code>timeout</code> nach <code>5 sek</code>. </li>
</ul>
<p>Wir passen nun in der <code>feed.js</code> noch die beiden Funktionen <code>openCreatePostModal()</code> und <code>closeCreatePostModal()</code> an:</p>
<div class="tabbed-set" data-tabs="17:1"><input checked="checked" id="__tabbed_17_1" name="__tabbed_17" type="radio" /><label for="__tabbed_17_1">public/src/js/feed.js</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>109
110
111
112
113
114
115
116
117
118
119
120
121
122</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">function</span> <span class="nx">openCreatePostModal</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">createPostArea</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">transform</span> <span class="o">=</span> <span class="s1">&#39;translateY(0)&#39;</span><span class="p">;</span>
    <span class="nx">initializeMedia</span><span class="p">();</span>
<span class="hll">    <span class="nx">initializeLocation</span><span class="p">();</span>
</span><span class="p">}</span>

<span class="kd">function</span> <span class="nx">closeCreatePostModal</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">createPostArea</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">transform</span> <span class="o">=</span> <span class="s1">&#39;translateY(100vH)&#39;</span><span class="p">;</span>
    <span class="nx">imagePickerArea</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
    <span class="nx">videoPlayer</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
    <span class="nx">canvasElement</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
<span class="hll">    <span class="nx">locationButton</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;inline&#39;</span><span class="p">;</span>
</span><span class="hll">    <span class="nx">locationLoader</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
</span><span class="p">}</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>Wenn Sie die Anwenung nun starten, werden Sie gefragt, ob Sie die Abfrage nach Ihrem Standort zulassen oder blockieren wollen. Die meisten von Ihnen werden aber die <strong>Ortungsdienste ausgeschaltet</strong> haben. Dann ist auch die Abfrage zunächst egal. Im Mac kann man diese (kurzzeitig, dann wieder ausschalten) über <code>Systemeinstellungen --&gt; Sicherheit &amp; Datenschutz --&gt; Reiter Datenschutz --&gt; Ortungsdienste</code> für <code>Google Chrome</code> aktivieren. </p>
<p>Wenn Sie die Positionsbestimmung zulassen, dann wird nach dem Klicken auf den <code>Location</code>-Button die aktuelle Position auf der Konsole eingegeben und im Formular erscheint unter Ort <code>In Berlin</code>.</p>
<p>Wir machen nichts weiter mit der aktuellen Position. Es gibt viele Möglichkeiten, die jetzt noch ausprobiert werden könnten. Dazu gehören besipeilsweise:</p>
<ul>
<li>Wir könnten mithilfe der <a href="https://developers.google.com/maps/documentation/geolocation/overview">Google-Geolocation-API</a> die Adresse ermitteln, die Google für eine gegebene Position (<code>longitude</code> und <code>latitude</code>) zurückgibt. Dazu bräuchten wir aber auch einen <a href="https://developers.google.com/maps/documentation/geolocation/get-api-key">API-Key</a> von Google.</li>
<li>Wir könnten das Gleiche mit der <a href="https://nominatim.org/">Nominatim-API</a> für Open Street Map machen. Sie können den Service <a href="https://nominatim.openstreetmap.org/ui/reverse.html">hier einmal ausprobieren</a>, indem Sie Ihre <code>latitude</code> und <code>longitude</code> aus der Konsolenausgabe eingeben.</li>
<li>Wir könnten <a href="https://openlayers.org/en/latest/doc/quickstart.html">OpenLayers</a> verwenden, um die Position auf einer Karte anzuzeigen.</li>
<li>Wir könnten die Datenbank erweitern und für alle Posts auch noch die Koordinaten der Position abspeichern und dann alle Posts auf einer Karte (mithilfe von OpenLayers + OpenStreetMap) visualisieren.</li>
<li>...</li>
</ul>
<h3 id="letzte-verbesserungen">Letzte Verbesserungen<a class="headerlink" href="#letzte-verbesserungen" title="Permanent link">&para;</a></h3>
<p>Ein Nachteil in unserer Anwendung ist noch, dass die Kamera die ganze Zeit läuft, wenn wir einmal den modalen Dialog zur Eingabe von daten geöffnet hatten. Wir sollten sie beim Ausschalten des modalen Dialoges schließen. Das Stoppen aller Videostreams hatten wir bereits für die Aufnahme des Fotos gemacht. Weil jedoch das Schließen und erneutes Öffnen der Kamera sehr ressourcenverbrauchend ist, laufen die Animationen für das Öffnen und Schließen des modalen Dialogs nicht mehr flüssig. Wir lagern diese Animationen deshalb in einen asynchronen "Thread" aus (ist nicht wirklich ein neuer Thread): </p>
<div class="tabbed-set" data-tabs="18:1"><input checked="checked" id="__tabbed_18_1" name="__tabbed_18" type="radio" /><label for="__tabbed_18_1">public/src/js/feed.js</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">function</span> <span class="nx">openCreatePostModal</span><span class="p">()</span> <span class="p">{</span>
<span class="hll">    <span class="nx">setTimeout</span><span class="p">(</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class="hll">        <span class="nx">createPostArea</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">transform</span> <span class="o">=</span> <span class="s1">&#39;translateY(0)&#39;</span><span class="p">;</span>
</span><span class="hll">    <span class="p">},</span> <span class="mf">1</span><span class="p">);</span>
</span>    <span class="nx">initializeMedia</span><span class="p">();</span>
    <span class="nx">initializeLocation</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">closeCreatePostModal</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">imagePickerArea</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
    <span class="nx">videoPlayer</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
    <span class="nx">canvasElement</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
    <span class="nx">locationButton</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;inline&#39;</span><span class="p">;</span>
    <span class="nx">locationLoader</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
<span class="hll">    <span class="k">if</span><span class="p">(</span><span class="nx">videoPlayer</span><span class="p">.</span><span class="nx">srcObject</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">        <span class="nx">videoPlayer</span><span class="p">.</span><span class="nx">srcObject</span><span class="p">.</span><span class="nx">getVideoTracks</span><span class="p">().</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">track</span> <span class="p">=&gt;</span> <span class="nx">track</span><span class="p">.</span><span class="nx">stop</span><span class="p">());</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="hll">    <span class="nx">setTimeout</span><span class="p">(</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class="hll">        <span class="nx">createPostArea</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">transform</span> <span class="o">=</span> <span class="s1">&#39;translateY(100vH)&#39;</span><span class="p">;</span>
</span><span class="hll">    <span class="p">},</span> <span class="mf">1</span><span class="p">);</span>
</span><span class="p">}</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>Mithilfe des <code>timeout</code>-"Tricks" wird der modale Dialog fließend geschlossen und das Kamerazeichen im Tab des Browsers schließt asynchron etwas später. </p>
<div class="admonition success">
<p class="admonition-title">Success</p>
<p>Wir haben erfolgreich den Zugriff auf die Kamera (MediaDevices-API) und die Geolocation-API ausprobiert und in unsere Anwendung eingebunden. Die MediaDevices-API bietet neben der <code>video</code>-Eigenschaft auch noch die <code>audio</code>-Eigenschaft, um das Mikrofon zu verwenden. Mit dem Zugriff auf Kamera und Position haben wir unsere letzte <em>progressive</em> Funktionalität für dieses Semester hinzugefügt! Geschafft! </p>
</div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../pushnotes/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Zurück
                </span>
                Push Notifications
              </div>
            </div>
          </a>
        
        
          <a href="../zusammenfassung/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Weiter
                </span>
                Zusammenfassung
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2020 Jörn Freiheit
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.18f0862e.min.js"></script>
      <script src="../assets/javascripts/bundle.994580cf.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "In Zwischenablage kopieren", "clipboard.copied": "In Zwischenablage kopiert", "search.config.lang": "de", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Suche", "search.result.placeholder": "Suchbegriff eingeben", "search.result.none": "Keine Suchergebnisse", "search.result.one": "1 Suchergebnis", "search.result.other": "# Suchergebnisse", "search.result.more.one": "1 weiteres Suchergebnis auf dieser Seite", "search.result.more.other": "# weitere Suchergebnisse auf dieser Seite", "search.result.term.missing": "Es fehlt"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: ['instant', 'tabs'],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.9c0e82ba.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>